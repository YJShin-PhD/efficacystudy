import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from scipy import stats
from statsmodels.stats.multicomp import pairwise_tukeyhsd, MultiComparison
import io
import os

# 1. ì‹œìŠ¤í…œ ì„¤ì • ë° ì‚¬ìš©ì DB
st.set_page_config(page_title="Tox-Hub Analysis Platform", layout="wide")

# [ë³´ì•ˆ ì„¤ì •] ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” ì™¸ë¶€ íŒŒì¼ë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
USER_DB = {
    "admin": {"pw": "tox1234", "role": "admin", "name": "ê´€ë¦¬ì(ë°•ì‚¬ë‹˜)"},
    "client01": {"pw": "guest01", "role": "user", "name": "Aì œì•½ì‚¬", "prefix": "C01_"},
    "client02": {"pw": "guest02", "role": "user", "name": "Bì—°êµ¬ì†Œ", "prefix": "C02_"}
}

DATA_DIR = "data"
if not os.path.exists(DATA_DIR):
    os.makedirs(DATA_DIR)

# 2. í•„ìˆ˜ í•¨ìˆ˜ ì •ì˜
def load_study_files(prefix=""):
    """í´ë” ë‚´ íŒŒì¼ ì¤‘ ê¶Œí•œì´ ìˆëŠ” íŒŒì¼ë§Œ ë¦¬ìŠ¤íŠ¸ì—…"""
    files = [f for f in os.listdir(DATA_DIR) if f.endswith(('.xlsx', '.csv'))]
    if prefix:
        return sorted([f for f in files if f.startswith(prefix)])
    return sorted(files)

def to_excel_final(summary, stats_dict):
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        summary.to_excel(writer, index=False, sheet_name='Summary_Data')
        if stats_dict:
            for method, result_df in stats_dict.items():
                if result_df is not None:
                    sheet_name = f'Stat_{method}'[:30]
                    result_df.to_excel(writer, index=False, sheet_name=sheet_name)
    return output.getvalue()

# 3. ë¡œê·¸ì¸ ì„¸ì…˜ ê´€ë¦¬
if 'logged_in' not in st.session_state:
    st.session_state.logged_in = False
    st.session_state.user_role = None
    st.session_state.user_id = None

# --- ë¡œê·¸ì¸ í™”ë©´ ---
if not st.session_state.logged_in:
    st.title("ğŸ” Toxicology Data Portal")
    with st.form("login_form"):
        input_id = st.text_input("ì•„ì´ë””(ID)")
        input_pw = st.text_input("ë¹„ë°€ë²ˆí˜¸(Password)", type="password")
        submit_btn = st.form_submit_button("ë¡œê·¸ì¸")
        
        if submit_btn:
            if input_id in USER_DB and USER_DB[input_id]["pw"] == input_pw:
                st.session_state.logged_in = True
                st.session_state.user_id = input_id
                st.session_state.user_role = USER_DB[input_id]["role"]
                st.rerun()
            else:
                st.error("ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
    st.stop()

# --- ë©”ì¸ í™”ë©´ (ë¡œê·¸ì¸ í›„) ---
st.sidebar.info(f"ğŸ‘¤ ì ‘ì†: {USER_DB[st.session_state.user_id]['name']} ë‹˜")
if st.sidebar.button("ë¡œê·¸ì•„ì›ƒ"):
    st.session_state.logged_in = False
    st.rerun()

# íƒ­ êµ¬ì„±: ê³ ê°ì€ Viewerë§Œ, ê´€ë¦¬ìëŠ” Admin íƒ­ê¹Œì§€ ë…¸ì¶œ
if st.session_state.user_role == "admin":
    tabs = st.tabs(["ğŸ“Š Study Viewer", "âš™ï¸ Admin Management"])
else:
    tabs = st.tabs(["ğŸ“Š Study Viewer"])

# --- [Tab 1: ë°ì´í„° ì‹œê°í™” (ê³µí†µ)] ---
with tabs[0]:
    user_prefix = USER_DB[st.session_state.user_id].get("prefix", "")
    available_files = load_study_files(user_prefix)
    
    if not available_files:
        st.warning("ì¡°íšŒ ê°€ëŠ¥í•œ ì‹¤í—˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
    else:
        selected_file = st.selectbox("ğŸ”¬ ë¶„ì„í•  ì‹¤í—˜ì„ ì„ íƒí•˜ì„¸ìš”", available_files)
        file_path = os.path.join(DATA_DIR, selected_file)
        df = pd.read_excel(file_path) if selected_file.endswith('.xlsx') else pd.read_csv(file_path)
        
        # [ê¸°ì¡´ ë¶„ì„ ë¡œì§ ë™ì¼ ì ìš©]
        st.sidebar.divider()
        st.sidebar.header("ğŸ“Š ë¶„ì„ ì„¤ì •")
        cols = df.columns.tolist()
        group_col = st.sidebar.selectbox("ê·¸ë£¹ ì—´", cols, index=cols.index('Group') if 'Group' in cols else 0)
        day_col = st.sidebar.selectbox("ë‚ ì§œ ì—´", cols, index=cols.index('Day') if 'Day' in cols else 0)
        weight_col = st.sidebar.selectbox("ë°ì´í„° ì—´", cols, index=0)
        
        all_days = sorted(df[day_col].unique())
        all_groups = sorted(df[group_col].unique())
        selected_groups = st.sidebar.multiselect("ê·¸ë£¹ í•„í„°", all_groups, default=all_groups)

        # ê·¸ë˜í”„ ì¶œë ¥
        graph_df = df[df[group_col].isin(selected_groups)]
        df_stats = graph_df.groupby([group_col, day_col])[weight_col].agg(['mean', 'sem']).reset_index()
        fig = go.Figure()
        for group in selected_groups:
            g_data = df_stats[df_stats[group_col] == group]
            fig.add_trace(go.Scatter(x=g_data[day_col], y=g_data['mean'], name=group, mode='lines+markers'))
        st.plotly_chart(fig, use_container_width=True)
        
        # ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        summary = graph_df.groupby([group_col])[weight_col].agg(['count', 'mean', 'sem']).reset_index()
        st.dataframe(summary)
        excel_data = to_excel_final(summary, {})
        st.sidebar.download_button("ğŸ“¥ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ", data=excel_data, file_name=f"Report_{selected_file}.xlsx")

# --- [Tab 2: ê´€ë¦¬ì ì „ìš© ì—…ë¡œë“œ (Admin ì „ìš©)] ---
if st.session_state.user_role == "admin":
    with tabs[1]:
        st.header("ğŸ“¤ ìƒˆ ì‹¤í—˜ ë°ì´í„° ë“±ë¡")
        st.info("íŒŒì¼ëª… ì•ì— ê³ ê° ì ‘ë‘ì–´(ì˜ˆ: C01_)ë¥¼ ë¶™ì—¬ì„œ ì—…ë¡œë“œí•˜ë©´ í•´ë‹¹ ê³ ê°ì—ê²Œë§Œ ë…¸ì¶œë©ë‹ˆë‹¤.")
        
        target_client = st.selectbox("ì§€ì •í•  ê³ ê°ì‚¬ ì„ íƒ", ["ì„ íƒ ì•ˆ í•¨"] + [k for k, v in USER_DB.items() if v['role'] == 'user'])
        up_file = st.file_uploader("ì—‘ì…€ íŒŒì¼ ì„ íƒ", type=['xlsx', 'csv'])
        
        if st.button("íŒŒì¼ ì„œë²„ ì €ì¥"):
            if up_file and target_client != "ì„ íƒ ì•ˆ í•¨":
                prefix = USER_DB[target_client]['prefix']
                save_name = f"{prefix}{up_file.name}"
                with open(os.path.join(DATA_DIR, save_name), "wb") as f:
                    f.write(up_file.getbuffer())
                st.success(f"ì„±ê³µ: '{save_name}' íŒŒì¼ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.")
                st.rerun()
            else:
                st.error("ê³ ê°ì‚¬ë¥¼ ì„ íƒí•˜ê³  íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")

        st.divider()
        st.subheader("ğŸ—‘ï¸ ì„œë²„ íŒŒì¼ ëª©ë¡ ê´€ë¦¬")
        all_f = load_study_files()
        for f in all_f:
            if st.button(f"ì‚­ì œ: {f}", key=f):
                os.remove(os.path.join(DATA_DIR, f))
                st.rerun()